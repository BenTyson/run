<html>
<head>
<!--Run. Run away.  -->
    
<script type="text/javascript">

var runDiv;
var dotSize = 15;

var lineLen = 8;
var numLines = 8;
var lineStepSize = 15;

var lineInterval = Math.floor(window.innerHeight / numLines);

var lines;
var firstLine;
var lastLine;

var endzonePercent = 0.2; //when dot enters this zone it gets put back to reposition
var repositionPercent = 0.5;

function ready() {
    
    createLines();
    setLines();
    

    runDiv = document.createElement("DIV");
    
    var y = window.innerHeight - dotSize;
    var x= Math.floor(window.innerWidth / 2);
    var startPosStyle = "left: " + x + "px; top: " + y + "px; "
    
    var styleAttr = document.createAttribute("style");
    styleAttr.value = "position:absolute; background-color:red; width:"+ dotSize +"px; height:"+ dotSize + "px; " + startPosStyle; 
    runDiv.setAttributeNode(styleAttr);  
    
    document.body.appendChild(runDiv);


}

document.onkeydown = checkKey;



function checkKey(e) {

    e = e || window.event;

    if (e.keyCode == '38') {
        // move div up
        runStep("up");
    }
    else if (e.keyCode == '40') {
        //move div down
        runStep("dn");
        
    }
    else if (e.keyCode == '37') {
       //move div left
       runStep("lt");
    }
    else if (e.keyCode == '39') {
       //move div right
       runStep("rt");
    }
}

function runStep(stepKey) {
    
    var processStep = true;
    var newTop = runDiv.style.top;
    var newLeft = runDiv.style.left;;
    
    if(parseInt(runDiv.style.left) < 0) {
        //dot going out of window to left
        processStep = false;
        newLeft = "0px";
        runDiv.style.left = newLeft;        
    }
    
    if(parseInt(runDiv.style.left) + dotSize > window.innerWidth) {
        //dot going out of window to right
        processStep = false;
        newLeft = (window.innerWidth - dotSize) + "px";
        runDiv.style.left = newLeft;    
        
    }
    
    if (parseInt(runDiv.style.top) + dotSize > window.innerHeight) {
        //dot going out of window to bottom
        processStep = false;
        newTop = (window.innerHeight - dotSize) + "px";
        runDiv.style.top = newTop;
    }
    
    if(parseInt(runDiv.style.top) < (Math.floor(window.innerHeight * endzonePercent))) {
        //dot going up far enough to need repositioning
        processStep = false;
        newTop = (Math.floor(window.innerHeight) * repositionPercent) + "px";
        runDiv.style.top = newTop;  
    }
    

    if(processStep == true) {
        switch (stepKey) {
            case "up":
                newTop = (parseInt(runDiv.style.top) - dotSize) + "px";
                runDiv.style.top = newTop;
                stepLines("up");
                break;
            case "dn":
                newTop = (parseInt(runDiv.style.top) + dotSize) + "px";
                runDiv.style.top = newTop;  
                stepLines("dn");
                break;
            case "rt":
                newLeft = (parseInt(runDiv.style.left) + dotSize) + "px";
                runDiv.style.left = newLeft;
                break;
            case "lt":
                newLeft = (parseInt(runDiv.style.left) - dotSize) + "px";
                runDiv.style.left = newLeft;            
                break;
            default:
        }
        
        var rnd = Math.random();
        if (rnd < .1) { 
console.log("tackled", newTop)            
            makeTackler(0, newTop);
        }
        
        
    }
}

function stepLines(stepKey) {
    
    var stepLimit;
    var stepDir;
 
    if(stepKey == "up") {
        //target moving up, lines go down
        stepLimit = Math.floor(window.innerHeight) - 1;
        var lineAt = parseInt(lastLine.style.top); // + lineInterval;
        stepDir = 1;
        if(lineAt > stepLimit) {
            //we have passed limit
            setLines();
//console.log("downward limit - reset lines");            
        } else {
            //we roll
            moveLines(lineStepSize*stepDir);
//console.log("move lines down");
        }

    } else {
        //target moving down, lines go up
        stepLimit = 0;
        var lineAt = parseInt(firstLine.style.top);
        stepDir = -1;
        if(lineAt <= stepLimit) {
            //we have passed limit
            setLines();
//console.log("upward limit - reset lines");            
        } else {
            //we roll
            moveLines(lineStepSize*stepDir);
//console.log("move lines up");
        }
    }
    
    
}

function moveLines(shiftStep) {

    for (var i = 0; i < lines.length; i++) {
         {
            var oldTop = parseInt(lines[i].style.top);
            var newTop = ( oldTop + shiftStep) + "px";
            lines[i].style.top = newTop;
//console.log(oldTop, newTop, lineStepSize*stepDir);
        }
    }
}


function createLines() {

    for (var y = 0; y < (window.innerHeight - lineInterval); y = y + lineInterval) {

        var lineDiv = document.createElement("DIV");
        
        var styleAttr = document.createAttribute("style");
        styleAttr.value = "position:absolute; background-color:black; width:"+ lineLen +"px; height:1px;";             
        lineDiv.setAttributeNode(styleAttr);  

        var classAttr =  document.createAttribute("class");
        classAttr.value = "lineDiv";
        lineDiv.setAttributeNode(classAttr); 
        
        var idAttr =  document.createAttribute("id");
        idAttr.value = "line" + y;
        lineDiv.setAttributeNode(idAttr); 
        
        document.body.appendChild(lineDiv);        
    }
    
    //set globals - hak
    lines = document.getElementsByClassName("lineDiv");
    firstLine = lines[0];
    lastLine = lines[lines.length-1];
    
    //originally create the grad lines - run once 
    //NOTE add window change reset
    
    console.log("initialized lines"); 
  
}


function setLines() {
    
    

    var lines = document.getElementsByClassName("lineDiv");
    var yy = 0;
    
    for (var y = 0; y < (window.innerHeight - lineInterval); y = y + lineInterval) {
        var line = lines[yy]
        yy++;
        line.style.top = y + "px";
//console.log(yy, y, line.style.top);  
    }

}


function makeTackler(tklType, startY) {
    
    var tklSize = 10;
    var tklDiv = document.createElement("DIV");
        
    var styleAttr = document.createAttribute("style");
    styleAttr.value = "position:absolute; background-color:aqua; width:"+ tklSize +"px; height:" + tklSize + "px; top:" + startY;             
    tklDiv.setAttributeNode(styleAttr);  
    
    document.body.appendChild(tklDiv);   
    
    
    
    var timer = setInterval(runTkl, 10);
    var curPx = 0;
    
    
    function runTkl() {
        
        if(curPx >= window.innerWidth) {
            clearInterval(timer);
            document.body.removeChild(tklDiv);
        } else {
            
            tklDiv.style.left = curPx + "px";
            curPx = curPx + 4;
            
        }
        
    }
    
    
}


    
</script>
    
    
</head> 
<body onLoad="ready()">
    <!--<h3>Run. Run away.</h3>-->
</body>
    
</html>


 
